<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OAuth library functions: tests/oauthexample.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>tests/oauthexample.c</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="oauth_8h.html" title="OAuth.net implementation in POSIX-C.">oauth.h</a>&gt;</span>

<span class="keywordtype">int</span> parse_reply(<span class="keyword">const</span> <span class="keywordtype">char</span> *reply, <span class="keywordtype">char</span> **token, <span class="keywordtype">char</span> **secret) {
  <span class="keywordtype">int</span> rc;
  <span class="keywordtype">int</span> ok=1;
  <span class="keywordtype">char</span> **rv = NULL;
  rc = <a name="a0"></a><a class="code" href="oauth_8h.html#a55fbfb191d98e3b6bf197495aae35e3a" title="splits the given url into a parameter array.">oauth_split_url_parameters</a>(reply, &amp;rv);
  qsort(rv, rc, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *), <a name="a1"></a><a class="code" href="oauth_8h.html#a01769febf93ebffe0f572a89ed1e529a" title="string compare function for oauth parameters.">oauth_cmpstringp</a>);
  <span class="keywordflow">if</span>( rc==2 
      &amp;&amp; !strncmp(rv[0],<span class="stringliteral">&quot;oauth_token=&quot;</span>,11)
      &amp;&amp; !strncmp(rv[1],<span class="stringliteral">&quot;oauth_token_secret=&quot;</span>,18) ) {
    ok=0;
    <span class="keywordflow">if</span> (token)  *token =strdup(&amp;(rv[0][12]));
    <span class="keywordflow">if</span> (secret) *secret=strdup(&amp;(rv[1][19]));
    printf(<span class="stringliteral">&quot;key:    &#39;%s&#39;\nsecret: &#39;%s&#39;\n&quot;</span>,*token, *secret); <span class="comment">// XXX token&amp;secret may be NULL.</span>
  }
  <span class="keywordflow">if</span>(rv) free(rv);
  <span class="keywordflow">return</span> ok;
}

<span class="keywordtype">int</span> oauth_consumer_example(<span class="keywordtype">int</span> use_post) {
  <span class="keyword">const</span> <span class="keywordtype">char</span> *request_token_uri = <span class="stringliteral">&quot;http://term.ie/oauth/example/request_token.php&quot;</span>;
  <span class="keyword">const</span> <span class="keywordtype">char</span> *access_token_uri = <span class="stringliteral">&quot;http://term.ie/oauth/example/access_token.php&quot;</span>;
  <span class="keyword">const</span> <span class="keywordtype">char</span> *test_call_uri = <span class="stringliteral">&quot;http://term.ie/oauth/example/echo_api.php?method=foo%20bar&amp;bar=baz&quot;</span>;
  <span class="keyword">const</span> <span class="keywordtype">char</span> *c_key         = <span class="stringliteral">&quot;key&quot;</span>; <span class="comment">//&lt; consumer key</span>
  <span class="keyword">const</span> <span class="keywordtype">char</span> *c_secret      = <span class="stringliteral">&quot;secret&quot;</span>; <span class="comment">//&lt; consumer secret</span>

  <span class="keywordtype">char</span> *t_key    = NULL; <span class="comment">//&lt; access token key</span>
  <span class="keywordtype">char</span> *t_secret = NULL; <span class="comment">//&lt; access token secret</span>

  <span class="keywordtype">char</span> *req_url = NULL;
  <span class="keywordtype">char</span> *postarg = NULL;
  <span class="keywordtype">char</span> *reply   = NULL;

  printf(<span class="stringliteral">&quot;Request token..\n&quot;</span>);
  <span class="keywordflow">if</span> (use_post) { <span class="comment">// HTTP POST </span>
    req_url = <a name="a2"></a><a class="code" href="oauth_8h.html#ae2618222b0e3de2f3a081a3214ecddb0" title="calculate OAuth-signature for a given HTTP request URL, parameters and oauth-tokens.">oauth_sign_url2</a>(request_token_uri, &amp;postarg, <a name="a3"></a><a class="code" href="oauth_8h.html#a3794693efae6b44677be23834844e9d2a7113d5ffff7ee3a530150cdfe1618ae7" title="use HMAC-SHA1 request signing method">OA_HMAC</a>, NULL, c_key, c_secret, NULL, NULL);
    reply = <a name="a4"></a><a class="code" href="oauth_8h.html#a940cea46f3521bc4f4cc2f9cf750814f" title="do a HTTP POST request, wait for it to finish and return the content of the reply.">oauth_http_post</a>(req_url,postarg);
  } <span class="keywordflow">else</span> { <span class="comment">// HTTP GET</span>
    req_url = <a class="code" href="oauth_8h.html#ae2618222b0e3de2f3a081a3214ecddb0" title="calculate OAuth-signature for a given HTTP request URL, parameters and oauth-tokens.">oauth_sign_url2</a>(request_token_uri, NULL, <a class="code" href="oauth_8h.html#a3794693efae6b44677be23834844e9d2a7113d5ffff7ee3a530150cdfe1618ae7" title="use HMAC-SHA1 request signing method">OA_HMAC</a>, NULL, c_key, c_secret, NULL, NULL);
    reply = <a name="a5"></a><a class="code" href="oauth_8h.html#a1e6e64ef010fb626a90446d21d119872" title="do a HTTP GET request, wait for it to finish and return the content of the reply.">oauth_http_get</a>(req_url,postarg);
  }
  <span class="keywordflow">if</span> (req_url) free(req_url);
  <span class="keywordflow">if</span> (postarg) free(postarg);
  <span class="keywordflow">if</span> (!reply) <span class="keywordflow">return</span>(1);
  <span class="keywordflow">if</span> (parse_reply(reply, &amp;t_key, &amp;t_secret)) <span class="keywordflow">return</span>(2);
  free(reply);

  <span class="comment">// The Request Token provided above is already authorized, for this test server</span>
  <span class="comment">// so we may use it to request an Access Token right away.</span>

  printf(<span class="stringliteral">&quot;Access token..\n&quot;</span>);

  <span class="keywordflow">if</span> (use_post) {
    req_url = <a class="code" href="oauth_8h.html#ae2618222b0e3de2f3a081a3214ecddb0" title="calculate OAuth-signature for a given HTTP request URL, parameters and oauth-tokens.">oauth_sign_url2</a>(access_token_uri, &amp;postarg, <a class="code" href="oauth_8h.html#a3794693efae6b44677be23834844e9d2a7113d5ffff7ee3a530150cdfe1618ae7" title="use HMAC-SHA1 request signing method">OA_HMAC</a>, NULL, c_key, c_secret, t_key, t_secret);
    reply = <a class="code" href="oauth_8h.html#a940cea46f3521bc4f4cc2f9cf750814f" title="do a HTTP POST request, wait for it to finish and return the content of the reply.">oauth_http_post</a>(req_url,postarg);
  } <span class="keywordflow">else</span> {
    req_url = <a class="code" href="oauth_8h.html#ae2618222b0e3de2f3a081a3214ecddb0" title="calculate OAuth-signature for a given HTTP request URL, parameters and oauth-tokens.">oauth_sign_url2</a>(access_token_uri, NULL, <a class="code" href="oauth_8h.html#a3794693efae6b44677be23834844e9d2a7113d5ffff7ee3a530150cdfe1618ae7" title="use HMAC-SHA1 request signing method">OA_HMAC</a>, NULL, c_key, c_secret, t_key, t_secret);
    reply = <a class="code" href="oauth_8h.html#a1e6e64ef010fb626a90446d21d119872" title="do a HTTP GET request, wait for it to finish and return the content of the reply.">oauth_http_get</a>(req_url,postarg);
  }
  <span class="keywordflow">if</span> (req_url) free(req_url);
  <span class="keywordflow">if</span> (postarg) free(postarg);
  <span class="keywordflow">if</span> (!reply) <span class="keywordflow">return</span>(3);
  <span class="keywordflow">if</span>(t_key) free(t_key);
  <span class="keywordflow">if</span>(t_secret) free(t_secret);
  <span class="keywordflow">if</span> (parse_reply(reply, &amp;t_key, &amp;t_secret)) <span class="keywordflow">return</span>(4);
  free(reply);

  printf(<span class="stringliteral">&quot;make some request..\n&quot;</span>);

  <span class="keywordflow">if</span> (use_post) {
    req_url = <a class="code" href="oauth_8h.html#ae2618222b0e3de2f3a081a3214ecddb0" title="calculate OAuth-signature for a given HTTP request URL, parameters and oauth-tokens.">oauth_sign_url2</a>(test_call_uri, &amp;postarg, <a class="code" href="oauth_8h.html#a3794693efae6b44677be23834844e9d2a7113d5ffff7ee3a530150cdfe1618ae7" title="use HMAC-SHA1 request signing method">OA_HMAC</a>, NULL, c_key, c_secret, t_key, t_secret);
    reply = <a class="code" href="oauth_8h.html#a940cea46f3521bc4f4cc2f9cf750814f" title="do a HTTP POST request, wait for it to finish and return the content of the reply.">oauth_http_post</a>(req_url,postarg);
  } <span class="keywordflow">else</span> {
    req_url = <a class="code" href="oauth_8h.html#ae2618222b0e3de2f3a081a3214ecddb0" title="calculate OAuth-signature for a given HTTP request URL, parameters and oauth-tokens.">oauth_sign_url2</a>(test_call_uri, NULL, <a class="code" href="oauth_8h.html#a3794693efae6b44677be23834844e9d2a7113d5ffff7ee3a530150cdfe1618ae7" title="use HMAC-SHA1 request signing method">OA_HMAC</a>, NULL, c_key, c_secret, t_key, t_secret);
    reply = <a class="code" href="oauth_8h.html#a1e6e64ef010fb626a90446d21d119872" title="do a HTTP GET request, wait for it to finish and return the content of the reply.">oauth_http_get</a>(req_url,postarg);
  }
  printf(<span class="stringliteral">&quot;query:&#39;%s&#39;\n&quot;</span>,req_url);
  printf(<span class="stringliteral">&quot;reply:&#39;%s&#39;\n&quot;</span>,reply);
  <span class="keywordflow">if</span>(req_url) free(req_url);
  <span class="keywordflow">if</span>(postarg) free(postarg);

  <span class="keywordflow">if</span> (strcmp(reply,<span class="stringliteral">&quot;bar=baz&amp;method=foo+bar&quot;</span>)) <span class="keywordflow">return</span> (5);

  <span class="keywordflow">if</span>(reply) free(reply);
  <span class="keywordflow">if</span>(t_key) free(t_key);
  <span class="keywordflow">if</span>(t_secret) free(t_secret);

  <span class="keywordflow">return</span>(0);
}


<span class="keywordtype">int</span> main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) {
  <span class="keywordflow">switch</span>(oauth_consumer_example(0)) {
    <span class="keywordflow">case</span> 1:
      printf(<span class="stringliteral">&quot;HTTP request for an oauth request-token failed.\n&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 2:
      printf(<span class="stringliteral">&quot;did not receive a request-token.\n&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 3:
      printf(<span class="stringliteral">&quot;HTTP request for an oauth access-token failed.\n&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 4:
      printf(<span class="stringliteral">&quot;did not receive an access-token.\n&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> 5:
      printf(<span class="stringliteral">&quot;test call &#39;echo-api&#39; did not respond correctly.\n&quot;</span>);
      <span class="keywordflow">break</span>;
    <span class="keywordflow">default</span>:
      printf(<span class="stringliteral">&quot;request ok.\n&quot;</span>);
      <span class="keywordflow">break</span>;
  }
  <span class="keywordflow">return</span>(0);
}
</pre></div> </div>
</div>
<hr class="footer"/><address class="footer"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>

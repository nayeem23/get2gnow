<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>OAuth library functions: tests/oauthtest.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>tests/oauthtest.c</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment">
<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;<a class="code" href="oauth_8h.html" title="OAuth.net implementation in POSIX-C.">oauth.h</a>&gt;</span>

<span class="comment">/* </span>
<span class="comment"> * a example requesting and parsing a request-token from an OAuth service-provider</span>
<span class="comment"> * excercising the oauth-HTTP GET function. - it is almost the same as </span>
<span class="comment"> * \ref request_token_example_post below. </span>
<span class="comment"> */</span>
<span class="keywordtype">void</span> request_token_example_get(<span class="keywordtype">void</span>) {
<span class="preprocessor">#if 0</span>
<span class="preprocessor"></span>  <span class="keyword">const</span> <span class="keywordtype">char</span> *request_token_uri = <span class="stringliteral">&quot;http://oauth-sandbox.mediamatic.nl/module/OAuth/request_token&quot;</span>;
  <span class="keyword">const</span> <span class="keywordtype">char</span> *req_c_key         = <span class="stringliteral">&quot;17b09ea4c9a4121145936f0d7d8daa28047583796&quot;</span>; <span class="comment">//&lt; consumer key</span>
  <span class="keyword">const</span> <span class="keywordtype">char</span> *req_c_secret      = <span class="stringliteral">&quot;942295b08ffce77b399419ee96ac65be&quot;</span>; <span class="comment">//&lt; consumer secret</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <span class="keyword">const</span> <span class="keywordtype">char</span> *request_token_uri = <span class="stringliteral">&quot;http://term.ie/oauth/example/request_token.php&quot;</span>;
  <span class="keyword">const</span> <span class="keywordtype">char</span> *req_c_key         = <span class="stringliteral">&quot;key&quot;</span>; <span class="comment">//&lt; consumer key</span>
  <span class="keyword">const</span> <span class="keywordtype">char</span> *req_c_secret      = <span class="stringliteral">&quot;secret&quot;</span>; <span class="comment">//&lt; consumer secret</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  <span class="keywordtype">char</span> *res_t_key    = NULL; <span class="comment">//&lt; replied key</span>
  <span class="keywordtype">char</span> *res_t_secret = NULL; <span class="comment">//&lt; replied secret</span>

  <span class="keywordtype">char</span> *req_url = NULL;
  <span class="keywordtype">char</span> *reply;

  req_url = <a name="a0"></a><a class="code" href="oauth_8h.html#ae2618222b0e3de2f3a081a3214ecddb0" title="calculate OAuth-signature for a given HTTP request URL, parameters and oauth-tokens.">oauth_sign_url2</a>(request_token_uri, NULL, <a name="a1"></a><a class="code" href="oauth_8h.html#a3794693efae6b44677be23834844e9d2a7113d5ffff7ee3a530150cdfe1618ae7" title="use HMAC-SHA1 request signing method">OA_HMAC</a>, NULL, req_c_key, req_c_secret, NULL, NULL);

  printf(<span class="stringliteral">&quot;request URL:%s\n\n&quot;</span>, req_url);
  reply = <a name="a2"></a><a class="code" href="oauth_8h.html#a1e6e64ef010fb626a90446d21d119872" title="do a HTTP GET request, wait for it to finish and return the content of the reply.">oauth_http_get</a>(req_url,NULL);
  <span class="keywordflow">if</span> (!reply) 
    printf(<span class="stringliteral">&quot;HTTP request for an oauth request-token failed.\n&quot;</span>);
  <span class="keywordflow">else</span> {
    <span class="comment">// parse reply - example:</span>
    <span class="comment">//&quot;oauth_token=2a71d1c73d2771b00f13ca0acb9836a10477d3c56&amp;oauth_token_secret=a1b5c00c1f3e23fb314a0aa22e990266&quot;</span>
    <span class="keywordtype">int</span> rc;
    <span class="keywordtype">char</span> **rv = NULL;

    printf(<span class="stringliteral">&quot;HTTP-reply: %s\n&quot;</span>, reply);
    rc = <a name="a3"></a><a class="code" href="oauth_8h.html#a55fbfb191d98e3b6bf197495aae35e3a" title="splits the given url into a parameter array.">oauth_split_url_parameters</a>(reply, &amp;rv);
    qsort(rv, rc, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *), <a name="a4"></a><a class="code" href="oauth_8h.html#a01769febf93ebffe0f572a89ed1e529a" title="string compare function for oauth parameters.">oauth_cmpstringp</a>);
    <span class="keywordflow">if</span>( rc==2 
        &amp;&amp; !strncmp(rv[0],<span class="stringliteral">&quot;oauth_token=&quot;</span>,11)
        &amp;&amp; !strncmp(rv[1],<span class="stringliteral">&quot;oauth_token_secret=&quot;</span>,18) ){
          res_t_key=strdup(&amp;(rv[0][12]));
          res_t_secret=strdup(&amp;(rv[1][19]));
          printf(<span class="stringliteral">&quot;key:    &#39;%s&#39;\nsecret: &#39;%s&#39;\n&quot;</span>,res_t_key, res_t_secret);
    }
    <span class="keywordflow">if</span>(rv) free(rv);
  }

  <span class="keywordflow">if</span>(req_url) free(req_url);
  <span class="keywordflow">if</span>(reply) free(reply);
  <span class="keywordflow">if</span>(res_t_key) free(res_t_key);
  <span class="keywordflow">if</span>(res_t_secret) free(res_t_secret);
}

<span class="comment">/*</span>
<span class="comment"> * a example requesting and parsing a request-token from an OAuth service-provider</span>
<span class="comment"> * using the oauth-HTTP POST function.</span>
<span class="comment"> */</span>
<span class="keywordtype">void</span> request_token_example_post(<span class="keywordtype">void</span>) {
<span class="preprocessor">#if 0</span>
<span class="preprocessor"></span>  <span class="keyword">const</span> <span class="keywordtype">char</span> *request_token_uri = <span class="stringliteral">&quot;http://oauth-sandbox.mediamatic.nl/module/OAuth/request_token&quot;</span>;
  <span class="keyword">const</span> <span class="keywordtype">char</span> *req_c_key         = <span class="stringliteral">&quot;17b09ea4c9a4121145936f0d7d8daa28047583796&quot;</span>; <span class="comment">//&lt; consumer key</span>
  <span class="keyword">const</span> <span class="keywordtype">char</span> *req_c_secret      = <span class="stringliteral">&quot;942295b08ffce77b399419ee96ac65be&quot;</span>; <span class="comment">//&lt; consumer secret</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>  <span class="keyword">const</span> <span class="keywordtype">char</span> *request_token_uri = <span class="stringliteral">&quot;http://term.ie/oauth/example/request_token.php&quot;</span>;
  <span class="keyword">const</span> <span class="keywordtype">char</span> *req_c_key         = <span class="stringliteral">&quot;key&quot;</span>; <span class="comment">//&lt; consumer key</span>
  <span class="keyword">const</span> <span class="keywordtype">char</span> *req_c_secret      = <span class="stringliteral">&quot;secret&quot;</span>; <span class="comment">//&lt; consumer secret</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>  <span class="keywordtype">char</span> *res_t_key    = NULL; <span class="comment">//&lt; replied key</span>
  <span class="keywordtype">char</span> *res_t_secret = NULL; <span class="comment">//&lt; replied secret</span>

  <span class="keywordtype">char</span> *postarg = NULL;
  <span class="keywordtype">char</span> *req_url;
  <span class="keywordtype">char</span> *reply;

  req_url = <a class="code" href="oauth_8h.html#ae2618222b0e3de2f3a081a3214ecddb0" title="calculate OAuth-signature for a given HTTP request URL, parameters and oauth-tokens.">oauth_sign_url2</a>(request_token_uri, &amp;postarg, <a class="code" href="oauth_8h.html#a3794693efae6b44677be23834844e9d2a7113d5ffff7ee3a530150cdfe1618ae7" title="use HMAC-SHA1 request signing method">OA_HMAC</a>, NULL, req_c_key, req_c_secret, NULL, NULL);

  printf(<span class="stringliteral">&quot;request URL:%s\n\n&quot;</span>, req_url);
  reply = <a name="a5"></a><a class="code" href="oauth_8h.html#a940cea46f3521bc4f4cc2f9cf750814f" title="do a HTTP POST request, wait for it to finish and return the content of the reply.">oauth_http_post</a>(req_url,postarg);
  <span class="keywordflow">if</span> (!reply) 
    printf(<span class="stringliteral">&quot;HTTP request for an oauth request-token failed.\n&quot;</span>);
  <span class="keywordflow">else</span> {
    <span class="comment">//parse reply - example:</span>
    <span class="comment">//&quot;oauth_token=2a71d1c73d2771b00f13ca0acb9836a10477d3c56&amp;oauth_token_secret=a1b5c00c1f3e23fb314a0aa22e990266&quot;</span>
    <span class="keywordtype">int</span> rc;
    <span class="keywordtype">char</span> **rv = NULL;
    printf(<span class="stringliteral">&quot;HTTP-reply: %s\n&quot;</span>, reply);
    rc = <a class="code" href="oauth_8h.html#a55fbfb191d98e3b6bf197495aae35e3a" title="splits the given url into a parameter array.">oauth_split_url_parameters</a>(reply, &amp;rv);
    qsort(rv, rc, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *), <a class="code" href="oauth_8h.html#a01769febf93ebffe0f572a89ed1e529a" title="string compare function for oauth parameters.">oauth_cmpstringp</a>);
    <span class="keywordflow">if</span>( rc==2 
        &amp;&amp; !strncmp(rv[0],<span class="stringliteral">&quot;oauth_token=&quot;</span>,11)
        &amp;&amp; !strncmp(rv[1],<span class="stringliteral">&quot;oauth_token_secret=&quot;</span>,18) ){
          res_t_key=strdup(&amp;(rv[0][12]));
          res_t_secret=strdup(&amp;(rv[1][19]));
          printf(<span class="stringliteral">&quot;key:    &#39;%s&#39;\nsecret: &#39;%s&#39;\n&quot;</span>,res_t_key, res_t_secret);
    }
    <span class="keywordflow">if</span>(rv) free(rv);
  }

  <span class="keywordflow">if</span>(req_url) free(req_url);
  <span class="keywordflow">if</span>(postarg) free(postarg);
  <span class="keywordflow">if</span>(reply) free(reply);
  <span class="keywordflow">if</span>(res_t_key) free(res_t_key);
  <span class="keywordflow">if</span>(res_t_secret) free(res_t_secret);
}


<span class="comment">/*</span>
<span class="comment"> * Main Test and Example Code.</span>
<span class="comment"> * </span>
<span class="comment"> * compile:</span>
<span class="comment"> *  gcc -lssl -loauth -o oauthtest oauthtest.c</span>
<span class="comment"> */</span>
<span class="keywordtype">int</span> main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) {
  <span class="keywordtype">int</span> fail=0;

  <span class="keyword">const</span> <span class="keywordtype">char</span> *url      = <span class="stringliteral">&quot;http://base.url/&amp;just=append?post=or_get_parameters&quot;</span>
                         <span class="stringliteral">&quot;&amp;arguments=will_be_formatted_automatically?&amp;dont_care&quot;</span>
                         <span class="stringliteral">&quot;=about_separators&quot;</span>;
                         <span class="comment">//&lt; the url to sign</span>
  <span class="keyword">const</span> <span class="keywordtype">char</span> *c_key    = <span class="stringliteral">&quot;1234567890abcdef1234567890abcdef123456789&quot;</span>;
                        <span class="comment">//&lt; consumer key</span>
  <span class="keyword">const</span> <span class="keywordtype">char</span> *c_secret = <span class="stringliteral">&quot;01230123012301230123012301230123&quot;</span>;
                        <span class="comment">//&lt; consumer secret</span>
  <span class="keyword">const</span> <span class="keywordtype">char</span> *t_key    = <span class="stringliteral">&quot;0987654321fedcba0987654321fedcba098765432&quot;</span>;
                        <span class="comment">//&lt; token key</span>
  <span class="keyword">const</span> <span class="keywordtype">char</span> *t_secret = <span class="stringliteral">&quot;66666666666666666666666666666666&quot;</span>;
                        <span class="comment">//&lt; token secret</span>

<span class="preprocessor">#if 1 // example sign GET request and print the signed request URL</span>
<span class="preprocessor"></span>  {
    <span class="keywordtype">char</span> *geturl = NULL;
    geturl = <a class="code" href="oauth_8h.html#ae2618222b0e3de2f3a081a3214ecddb0" title="calculate OAuth-signature for a given HTTP request URL, parameters and oauth-tokens.">oauth_sign_url2</a>(url, NULL, <a class="code" href="oauth_8h.html#a3794693efae6b44677be23834844e9d2a7113d5ffff7ee3a530150cdfe1618ae7" title="use HMAC-SHA1 request signing method">OA_HMAC</a>, NULL, c_key, c_secret, t_key, t_secret);
    printf(<span class="stringliteral">&quot;GET: URL:%s\n\n&quot;</span>, geturl);
    <span class="keywordflow">if</span>(geturl) free(geturl);
  }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
<span class="preprocessor">#if 1 // sign POST ;) example </span>
<span class="preprocessor"></span>  {
    <span class="keywordtype">char</span> *postargs = NULL, *post = NULL;
    post = <a class="code" href="oauth_8h.html#ae2618222b0e3de2f3a081a3214ecddb0" title="calculate OAuth-signature for a given HTTP request URL, parameters and oauth-tokens.">oauth_sign_url2</a>(url, &amp;postargs, <a class="code" href="oauth_8h.html#a3794693efae6b44677be23834844e9d2a7113d5ffff7ee3a530150cdfe1618ae7" title="use HMAC-SHA1 request signing method">OA_HMAC</a>, NULL, c_key, c_secret, t_key, t_secret);
    printf(<span class="stringliteral">&quot;POST: URL:%s\n      PARAM:%s\n\n&quot;</span>, post, postargs);
    <span class="keywordflow">if</span>(post) free(post);
    <span class="keywordflow">if</span>(postargs) free(postargs);
  }
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  printf(<span class="stringliteral">&quot; *** sending HTTP request *** \n\n&quot;</span>);

<span class="comment">// These two will perform a HTTP request, requesting an access token. </span>
<span class="comment">// it&#39;s intended both as test (verify signature) </span>
<span class="comment">// and example code.</span>
<span class="preprocessor">#if 1 // POST a request-token request</span>
<span class="preprocessor"></span>  request_token_example_post();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span><span class="preprocessor">#if 1 // GET a request-token</span>
<span class="preprocessor"></span>  request_token_example_get();
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
  <span class="keywordflow">return</span> (fail?1:0);
}
</pre></div> </div>
</div>
<hr class="footer"/><address class="footer"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
